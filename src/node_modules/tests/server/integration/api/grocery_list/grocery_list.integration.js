'use strict';

import app from 'server';
import request from 'supertest';

let newGroceryList;

describe('GroceryList API:', () => {
  describe('GET /api/grocery_lists', () => {
    let groceryLists;

    beforeEach((done) => {
      request(app)
        .get('/api/grocery_lists')
        .expect(200)
        .expect('Content-Type', /json/)
        .end((err, res) => {
          if (err) {
            return done(err);
          }
          groceryLists = res.body;
          done();
        });
    });

    it('should respond with JSON array', () => {
      groceryLists.should.be.instanceOf(Array);
    });
  });

  describe('POST /api/grocery_lists', () => {
    beforeEach((done) => {
      request(app)
        .post('/api/grocery_lists')
        .send({
          title: 'New GroceryList',
        })
        .expect(201)
        .expect('Content-Type', /json/)
        .end((err, res) => {
          if (err) {
            return done(err);
          }
          newGroceryList = res.body;
          done();
        });
    });

    it('should respond with the newly created groceryList', () => {
      newGroceryList.title.should.equal('New GroceryList');
      newGroceryList.items.should.be.instanceOf(Array);
      newGroceryList.items.should.eql([]);
    });
  });

  describe('GET /api/grocery_lists/:id', () => {
    let groceryList;

    beforeEach((done) => {
      request(app)
        .get(`/api/grocery_lists/${newGroceryList._id}`)
        .expect(200)
        .expect('Content-Type', /json/)
        .end((err, res) => {
          if (err) {
            return done(err);
          }
          groceryList = res.body;
          done();
        });
    });

    afterEach(() => {
      groceryList = {};
    });

    it('should respond with the requested groceryList', () => {
      groceryList.title.should.equal('New GroceryList');
    });
  });

  describe('PUT /api/grocery_lists/:id', () => {
    let updatedGroceryList;

    beforeEach((done) => {
      request(app)
        .put(`/api/grocery_lists/${newGroceryList._id}`)
        .send({
          title: 'Updated GroceryList',
        })
        .expect(200)
        .expect('Content-Type', /json/)
        .end(function (err, res) {
          if (err) {
            return done(err);
          }
          updatedGroceryList = res.body;
          done();
        });
    });

    afterEach(() => {
      updatedGroceryList = {};
    });

    it('should respond with the original groceryList', () => {
      updatedGroceryList.title.should.equal('New GroceryList');
    });

    it('should respond with the updated groceryList on a subsequent GET', (done) => {
      request(app)
        .get(`/api/grocery_lists/${newGroceryList._id}`)
        .expect(200)
        .expect('Content-Type', /json/)
        .end((err, res) => {
          if (err) {
            return done(err);
          }
          let groceryList = res.body;

          groceryList.title.should.equal('Updated GroceryList');

          done();
        });
    });
  });

  describe('PATCH /api/grocery_lists/:id', () => {
    let patchedGroceryList;

    beforeEach((done) => {
      request(app)
        .patch(`/api/grocery_lists/${newGroceryList._id}`)
        .send([
          {op: 'replace', path: '/title', value: 'Patched GroceryList'}
        ])
        .expect(200)
        .expect('Content-Type', /json/)
        .end(function (err, res) {
          if (err) {
            return done(err);
          }
          patchedGroceryList = res.body;
          done();
        });
    });

    afterEach(() => {
      patchedGroceryList = {};
    });

    it('should respond with the patched groceryList', () => {
      patchedGroceryList.title.should.equal('Patched GroceryList');
    });
  });

  describe('DELETE /api/grocery_lists/:id', () => {
    let groceryList;

    beforeEach((done) => {
      request(app)
        .post('/api/grocery_lists')
        .send({
          title: 'New GroceryList',
        })
        .end((err, res) => {
          if (err) {
            return done(err);
          }
          groceryList = res.body;
          done();
        });
    });

    it('should respond with removed groceryList on successful removal', (done) => {
      request(app)
        .delete(`/api/grocery_lists/${groceryList._id}`)
        .expect(200)
        .expect('Content-Type', /json/)
        .end((err, res) => {
          if (err) {
            return done(err);
          }
          const removedGroceryList = res.body;

          removedGroceryList.should.eql(groceryList);
          done();
        });
    });

    it('should respond with 404 when groceryList does not exist', (done) => {
      request(app)
        .delete('/api/grocery_lists/580544a39180629f55a08e3e')
        .expect(404)
        .end(err => {
          if (err) {
            return done(err);
          }
          done();
        });
    });
  });
});
