import app from 'server';
import request from 'supertest-as-promised';
import {tokenCookie} from 'tests/server/shared/setup/authenticate';

sharedExamplesFor('JSON response', (getResponse, status = 200) => {
  subject(getResponse);

  it('responds with 200', () => {
    return $subject.then(res => expect(res).to.have.status(status));
  });

  it('responds with JSON', () => {
    return $subject.then(res => expect(res).to.be.json);
  });
});

sharedExamplesFor('API GET', (url, getToken) => {
  def('response', async() => {
    return request(app)
      .get(url)
      .set('Cookie', tokenCookie(await getToken()));
  });
  subject(() => $response.then(res => res.body));

  itBehavesLike('JSON response', get.definitionOf('response'));

  it('responds with array of entities', () => {
    return expect($subject).to.eventually.be.instanceOf(Array);
  });
});

sharedExamplesFor('API POST', (url, factoryName, getToken) => {
  let data;
  before(async () => {
    return data = await FactoryGirl.attrs(factoryName);
  });

  def('response', async() => {
    return request(app)
      .post(url)
      .set('Cookie', tokenCookie(await getToken()))
      .send(data);
  });
  subject(() => $response.then(res => res.body));

  itBehavesLike('JSON response', get.definitionOf('response'), 201);

  it('should respond with the newly created entity', () => {
    return expect($subject).to.eventually.include(data);
  });
});

sharedExamplesFor('API entity GET', (url, factoryName, getToken) => {
  let entity;
  before(async () => {
    return entity = await FactoryGirl.create(factoryName);
  });

  def('response', async() => {
    return request(app)
      .get(`${url}/${entity._id}`)
      .set('Cookie', tokenCookie(await getToken()));
  });
  subject(() => $response.then(res => res.body));

  itBehavesLike('JSON response', get.definitionOf('response'));

  it('should respond with the requested entity', () => {
    return expect($subject).to.eventually.have.property('_id').equal(entity._id.toString());
  });
});
