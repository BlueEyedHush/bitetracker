import app from 'server';
import request from 'supertest-as-promised';
import mongoose from 'mongoose';
import {tokenCookie} from 'tests/server/shared/setup/authenticate';

sharedExamplesFor('JSON response', (getResponse, status = 200) => {
  subject(getResponse);

  it('responds with 200', () => {
    return $subject.then(res => expect(res).to.have.status(status));
  });

  it('responds with JSON', () => {
    return $subject.then(res => expect(res).to.be.json);
  });
});

sharedExamplesFor('API GET', (url, getToken) => {
  def('response', async() => {
    return request(app)
      .get(url)
      .set('Cookie', tokenCookie(await getToken()));
  });

  itBehavesLike('JSON response', get.definitionOf('response'));

  subject(() => $response.then(res => res.body));
  it('responds with array of entities', () => {
    return expect($subject).to.eventually.be.instanceOf(Array);
  });
});

sharedExamplesFor('API POST', (url, factoryName, getToken) => {
  let data;

  before(async() => {
    data = await FactoryGirl.attrs(factoryName);
  });

  def('response', async() => {
    return request(app)
      .post(url)
      .set('Cookie', tokenCookie(await getToken()))
      .send(data);
  });

  itBehavesLike('JSON response', get.definitionOf('response'), 201);

  subject(() => $response.then(res => res.body));
  it('should respond with the newly created entity', () => {
    return expect($subject).to.eventually.include(data);
  });
});

sharedExamplesFor('API entity GET', (url, factoryName, getToken) => {
  let entity;

  def('response', async() => {
    return request(app)
      .get(`${url}/${entity._id}`)
      .set('Cookie', tokenCookie(await getToken()));
  });

  before(async() => {
    entity = await FactoryGirl.create(factoryName);
  });

  itBehavesLike('JSON response', get.definitionOf('response'));

  subject(() => $response.then(res => res.body));
  it('should respond with the requested entity', () => {
    return expect($subject).to.eventually.have.property('_id').equal(entity._id.toString());
  });
});

sharedExamplesFor('API PUT', (url, factoryName, getToken) => {
  let entity;

  def('response', async() => {
    return request(app)
      .put(`${url}/${entity._id}`)
      .set('Cookie', tokenCookie(await getToken()));
  });

  before(async() => {
    entity = await FactoryGirl.create(factoryName);
  });

  itBehavesLike('JSON response', get.definitionOf('response'));

  subject(() => $response.then(res => res.body));
  it('should respond with the updated recipe', () => {
    return expect($subject).to.eventually.have.property('_id').equal(entity._id.toString());
  });
});

sharedExamplesFor('API PATCH', (url, factoryName, property, getToken) => {
  let entity;

  def('op', () => ({op: 'replace', path: `/${property}`, value: '__test__'}));
  def('response', async() => {
    return request(app)
      .patch(`${url}/${entity._id}`)
      .set('Cookie', tokenCookie(await getToken()))
      .send([$op]);
  });

  before(async() => {
    entity = await FactoryGirl.create(factoryName);
  });

  itBehavesLike('JSON response', get.definitionOf('response'));

  subject(() => $response.then(res => res.body));
  it('should respond with the updated recipe', () => {
    return expect($subject).to.eventually.have.property(property).equal('__test__');
  });
});

sharedExamplesFor('API DELETE', (url, factoryName, getToken) => {
  context('when entity exists', () => {
    let entity;

    def('response', async() => {
      return request(app)
        .delete(`${url}/${entity._id}`)
        .set('Cookie', tokenCookie(await getToken()))
    });

    beforeEach(async() => {
      entity = await FactoryGirl.create(factoryName);
    });

    itBehavesLike('JSON response', get.definitionOf('response'));

    subject(() => $response.then(res => res.body));
    it('should respond with deleted entity', () => {
      return expect($subject).to.eventually.have.property('_id').equal(entity._id.toString());
    });
  });

  context('when entity does not exits', () => {
    it('should respond with 404', async () => {
      return request(app)
        .delete(`/api/recipes/${new mongoose.Types.ObjectId()}`)
        .set('Cookie', tokenCookie(await getToken()))
        .expect(404);
    });
  });
});
