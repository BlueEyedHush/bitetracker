import { mix } from 'mixwith'

import Subscriber from './Subscriber'

export default (stores) =>
    (superclass) => class extends mix(superclass).with(Subscriber) {
      constructor() {
        super(...arguments);
        if (!Array.isArray(stores)) {
          stores = [stores];
        }
        
        this.state = this.getStateFromStores();
        this.setStateFromStores = this.setStateFromStores.bind(this);
      }

      componentDidMount() {
        stores.forEach(store => this.addHandler(store, this.setStateFromStores));
      }

      componentWillUnmount() {
        this.destroyHandlers();
      }

      getStateFromStores() {
        return stores.reduce((state, store) => Object.assign(state, store.getState()), {});
      }

      setStateFromStores() {
        this.setState(this.getStateFromStores());
      }
    }