import alt from 'client/app/alt';
import moment from 'moment';

import MealsActions from 'client/app/actions/MealsActions';
import MealsSource from 'client/app/sources/MealsSource';
import NutrientsSource from 'client/app/sources/NutrientsSource';

ENERGY_ID = "208";
PROTEINS_ID = "203";
FAT_ID = "204";
CARBOHYDRATE_ID = "205";

/**
 * Stores meals for given date (initically current date is used).
 * Synchronization with server can be performed with fetchMeals action. It triggers state change.
 * Date can be altered using changeDate action. Changing date doesn't trigger state change, but it
 * it automatically triggers resynchronization, which in turn trigger state change.
 */
class MealsStore {
  constructor() {
    this.date = moment();
    this.meals = [];

    this.nutrients = [];
    this.failedNutrientFetches = 0;

    this.bindListeners({
      handleFetch: MealsActions.FETCH_MEALS,
      handleFetchSucceess: MealsActions.FETCH_MEALS_SUCCESS,
      handleFetchFailure: MealsActions.FETCH_MEALS_FAILURE,
      handleAdd: MealsActions.ADD_MEAL,
      handleAddSuccess: MealsActions.ADD_MEAL_SUCCESS,
      handleChangeDate: MealsActions.CHANGE_DATE,
      handleNutrientsFetchSuccess: MealsActions.FETCH_NUTRIENTS_SUCCESS,
      handleNutrientsFetchFailure: MealsActions.FETCH_NUTRIENTS_FAILURE,
    });
  }

  handleFetch() {
    MealsSource.fetch(this.date);
  }

  handleFetchSucceess(mealsList) {
    const todaysOnly = mealsList.filter(ml => this.date.isSame(ml.date, 'day'));
    this.setState({meals: todaysOnly});

    todaysOnly.forEach(meal => {
      NutrientsSource.fetch(meal.ndbno);
    });

    this.failedNutrientFetches = 0;
  }

  handleFetchFailure() {
    this.failedNutrientFetches = 0;
  }

  handleAdd({date, name, ndbno}) {
    MealsSource.create(date, name, ndbno);
  }

  handleAddSuccess(addedMeal) {
    const modifiedMealsList = this.meals.concat([addedMeal]);
    this.setState({meals: modifiedMealsList});
  }

  handleChangeDate(newDate) {
    this.date = newDate;
    MealsActions.fetchMeals.defer();
  }

  handleNutrientsFetchSuccess(nutrientsMap) {
    this.nutrients.push(nutrientsMap);
    if(this.nutrients.length + this.failedNutrientFetches == this.meals.length) {
      if(this.nutrients.length > 1) {
        this._calculateChartsData();
      } else {
        console.log('All nutrient fetches failed, no charts to display');
      }
    }
  }

  handleNutrientsFetchFailure() {
    this.failedNutrientFetches += 1;
  }

  _calculateChartsData() {
    console.log('Fetched nutrients, calculating chart data');
  }
}

export default alt.createStore(MealsStore, 'MealsStore');
